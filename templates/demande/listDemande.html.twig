{% extends 'base.html.twig' %}

{% block title %}Gestion des demandes{% endblock %}

{% block javascripts %}
    {{ parent() }}
    {{ encore_entry_script_tags('settings_demande') }}
{% endblock %}
{% block body %}
<div class="main">
<div class="container">
    <div class="row">
        <div class="col-md-12 mt-3">
            <div class="row no-gutters mb-2">
                <div class="col-md-6 d-flex justify-content-start align-items-center">
                    <div class="w-100">
                        <h5>LISTE DES DEMANDES :</h5>
                    </div>
                </div>
                <div class="col-md-6 d-flex justify-content-end align-items-center ml-auto">
                    <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#addDemande">
                        <i class="fa fa-plus"></i>
                    </button>
                </div>
            </div>

            <table id="demandeTable" class="table table-striped">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Dossier</th>
                        <th>Date demande</th>
                        <th>Benificiere</th>
                        <th>Contact</th>
                        <th>CIN</th>
                        <th>Nomber personnes</th>
                        <th>Adresse de depart</th>
                        <th>Tarif total</th>
                         <th>Description</th>
                        <th>observation</th>
                        <th>Statut</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                   
                </tbody>
            </table>
        </div>

<!-- MODAL AJOUTER UNE DEMANDE --> 
<div class="modal right fade" id="addDemande" tabindex="-1" role="dialog" aria-labelledby="addDemandeLabel" aria-hidden="true">
  <div class="modal-dialog" style="width: 90%;" role="document">
    <div class="modal-content d-flex flex-column h-100">
      <form id="formAddDemande" method="POST" action="{{ path('demande_ajouter') }}">

        <div class="modal-header">
          <h5 class="modal-title text-primary">AJOUTER UNE NOUVELLE DEMANDE</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close" id="closeAddDemande">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>

        <div class="modal-body">
          <div class="row">
            <!-- Informations générales -->
            <div class="col-md-6">
              <h5 class="text-primary">Informations générales</h5>

              <div class="form-row">
                <div class="col-md-6 mb-2">
                  <label for="nomBenificiaire">Nom du bénéficiaire</label>
                  <input type="text" name="nomBenificiaire" class="form-control form-control-sm" placeholder="Nom du bénéficiaire" required>
                </div>
                <div class="col-md-6 mb-2">
                  <label for="cin">CIN</label>
                  <input type="text" name="cin" class="form-control form-control-sm" placeholder="CIN">
                </div>
              </div>

              <div class="form-row">
                <div class="col-md-6 mb-2">
                  <label for="observation">Observation</label>
                  <input type="text" name="observation" class="form-control form-control-sm" placeholder="Observation">
                </div>
                <div class="col-md-6 mb-2">
                  <label for="description">Description</label>
                  <input type="text" name="description" class="form-control form-control-sm" placeholder="Description">
                </div>
              </div>

              <div class="form-row">
                <div class="col-md-6 mb-2">
                  <label for="contact">Contact</label>
                  <input type="text" name="contact" class="form-control form-control-sm" placeholder="Contact">
                </div>
                <div class="col-md-6 mb-2">
                  <label for="nbPersonnes">Nombre de personnes</label>
                  <input type="number" name="nbPersonnes" class="form-control form-control-sm" placeholder="Nombre de personnes">
                </div>
              </div>

              <div class="form-row">
                <div class="col-md-6 mb-2">
                  <label for="dateDemande">Date de la demande</label>
                  <input type="datetime-local" name="dateDemande" class="form-control form-control-sm" required>
                </div>
                <div class="col-md-6 mb-2">
                  <label for="adressDepart">Adresse de départ</label>
                  <input type="text" name="adressDepart" class="form-control form-control-sm" placeholder="Adresse de départ" required>
                </div>
              </div>
            </div>

            <!-- Détails -->
            <div class="col-md-6">
              <h5 class="text-primary">Détails de la demande</h5>

              <div class="form-row">
                <div class="col-md-6 mb-2">
                <label for="vehicule">Véhicule</label>
                  <select name="details[0][vehicule]" class="form-control form-control-sm">
                    {# <option value="">Véhicule</option> #}
                    {% for vehicule in vehicules %}
                      {% if vehicule.active == 1 %}
                      <option value="{{ vehicule.id }}">{{ vehicule.matricule }}</option>
                        {% endif %}
                    {% endfor %}
                  </select>
                </div>
                <div class="col-md-6 mb-2">
                <label for="conducteur">Conducteur</label>
                  <select name="details[0][conducteur]" class="form-control form-control-sm">
                    {# <option value="">Conducteur</option> #}
                    {% for conducteur in conducteurs %}
                      {% if conducteur.active == 1 %}
                      <option value="{{ conducteur.id }}">{{ conducteur.nom }}</option>
                       {% endif %}
                    {% endfor %}
                  </select>
                </div>
              </div>

              <div class="form-row">
                <div class="col-md-6 mb-2">
                <label for="add-type-prestation">Type de prestation</label>
                  <select name="details[0][type_prestation]" class="form-control form-control-sm" id="add-type-prestation">
                    <option value="">Type de prestation</option>
                    {% for type in typePrestations %}
                      <option value="{{ type.id }}">{{ type.libelle }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="col-md-6 mb-2">
                 <label for="add-zone">Adresse d'arrivée</label>
                  <select name="details[0][zone]" class="form-control form-control-sm" id="add-zone">
                    
                    {% for zone in zones %}
                      <option value="{{ zone.id }}">{{ zone.libelle }}</option>
                    {% endfor %}
                  </select>
                </div>
              </div>

              <div class="form-group mb-2">
              <label for="add-prestation-0">Prestation</label>
                <select name="details[0][prestation]" class="form-control form-control-sm" id="add-prestation-0">
                  <option value="">Prestation</option>
                </select>
              </div>

              <div class="form-row">
                <div class="col-md-6 mb-2">
                <label for="quantite">Quantité</label>
                  <input type="number" name="details[0][quantite]" class="form-control form-control-sm" placeholder="Quantité">
                </div>
                <div class="col-md-6 mb-2">
                <label for="nb_jours">Nombre de jours</label>
                  <input type="number" name="details[0][nb_jours]" class="form-control form-control-sm" placeholder="Nombre de jours">
                </div>
              </div>

              <div class="text-right">
                <button type="button" class="btn btn-outline-primary btn-sm" id="add-detail">
                  <i class="fa fa-plus"></i> Ajouter un détail
                </button>
              </div>
            </div>
          </div>

          <!-- Tableau des détails (sans tarif) -->
          <div class="mt-3" id="table-details-container" style="display: none;">
            <table class="table table-sm table-bordered" id="table-details">
              <thead class="thead-light">
                <tr>
                  <th>#</th>
                  <th>Véhicule</th>
                  <th>Conducteur</th>
                  <th>Type prestation</th>
                  <th>Adresse d'arrivée</th>
                  <th>Prestation</th>
                  <th>Quantité</th>
                  <th>Jours</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div class="modal-footer mt-auto d-flex justify-content-end">
          <button type="submit" class="btn btn-primary btn-sm">
            <i class="fa-regular fa-floppy-disk"></i> Enregistrer
          </button>
          <button type="button" class="btn btn-secondary ml-2" data-dismiss="modal">Annuler</button>
        </div>
      </form>
    </div>
  </div>
</div>






<!-- MODAL TRAITER UNE DEMANDE -->
<div class="modal right fade" id="traiterDemande" tabindex="-1" role="dialog" aria-labelledby="traiterDemandeLabel" aria-hidden="true">
  <div class="modal-dialog" style="width: 90%;" role="document">
    <div class="modal-content d-flex flex-column h-100">
   
      <form id="formTraiterDemande" method="POST" action="">

        
        <div class="modal-header">
          <h5 class="modal-title text-primary">TRAITER LA DEMANDE</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close" id="closeTraiterDemande">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>

        <div class="modal-body">
          <!-- 🔹 Informations générales -->
           <h5 class="text-primary">Informations générales</h5>
          <div class="row">
            <div class="col-md-6 mb-2">
              <input type="hidden" name="id" id="traiter-id">
               <label for="traiter-nom">Nom du bénéficiaire</label>
              <input type="text" name="nomBenificiaire" id="traiter-nom" class="form-control form-control-sm" placeholder="Nom du bénéficiaire" readonly>
            </div>
            <div class="col-md-6 mb-2">
             <label for="traiter-cin">CIN</label>
              <input type="text" name="cin" id="traiter-cin" class="form-control form-control-sm" placeholder="CIN" readonly>
            </div>
            <div class="col-md-6 mb-2">
             <label for="traiter-observation">Observation</label>
              <input type="text" name="observation" id="traiter-observation" class="form-control form-control-sm" placeholder="Observation" readonly>
            </div>
            <div class="col-md-6 mb-2">
            <label for="traiter-description">Description</label>
              <input type="text" name="description" id="traiter-description" class="form-control form-control-sm" placeholder="Description" readonly>
            </div>
            <div class="col-md-6 mb-2">
            <label for="traiter-contact">Contact</label>
              <input type="text" name="contact" id="traiter-contact" class="form-control form-control-sm" placeholder="Contact" readonly>
            </div>
            <div class="col-md-6 mb-2">
            <label for="traiter-nbPersonnes">Nombre de personnes</label>
              <input type="number" name="nbPersonnes" id="traiter-nbPersonnes" class="form-control form-control-sm" placeholder="Nombre de personnes" readonly>
            </div>
            <div class="col-md-6 mb-2">
             <label for="traiter-date">Date de la demande</label>
              <input type="datetime-local" name="dateDemande" id="traiter-date" class="form-control form-control-sm">
            </div>
            <div class="col-md-6 mb-2">
            <label for="traiter-adresse">Adresse de départ</label>
              <input type="text" name="adressDepart" id="traiter-adresse" class="form-control form-control-sm" placeholder="Adresse de départ" readonly>
            </div>
          </div>

          <!-- 🔸 Tableau des détails -->
          <h5 class="text-primary mt-3">Détails de la demande</h5>
          <div class="table-responsive">
            <table class="table table-bordered table-sm" id="traiter-details-table">
              <thead class="thead-light">
                <tr>
                  <th>#</th>
                  <th>Véhicule</th>
                  <th>Conducteur</th>
                  <th>Type</th>
                  <th>Adresse d'arrivée</th>
                  <th>Prestation</th>
                  <th>Quantité</th>
                  <th>Jours</th>
                  <th>Tarif</th>
                  <th>Kilommetrage</th>
                  <th>Jawaz</th>
                  <th>Carburant</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody>
                <!-- Les lignes seront ajoutées dynamiquement via JS -->
              </tbody>
            </table>
          </div>
        </div>

        <div class="modal-footer mt-auto d-flex justify-content-end">
           <button type="button" id="btn-traiter-enregistrer" class="btn btn-primary btn-sm">
            <i class="fa-regular fa-floppy-disk"></i> Enregistrer
          </button>
          <button type="button" class="btn btn-secondary ml-2" data-dismiss="modal">Annuler</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- MODAL : Modifier Détail -->
<div class="modal right fade" id="modifierDetailModal" tabindex="-1" role="dialog" aria-labelledby="modifierDetailModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-slideout" style="width: 40%;" role="document">
    <div class="modal-content">
      <form id="formModifierDetail">
        <div class="modal-header">
          <h5 class="modal-title text-primary">Modifier Détail De La Demande</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Fermer">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>

        <div class="modal-body">
          <input type="hidden" id="detail-id">

          <!-- Véhicule et Conducteur -->
          <div class="form-row">
            <div class="form-group col-6">
              <label for="edit-vehicule">Véhicule</label>
              <select class="form-control" id="edit-vehicule" name="vehicule">
                <option value=""></option>
                {% for vehicule in vehicules %}
                {% if vehicule.active == 1 %}
                  <option value="{{ vehicule.id }}">{{ vehicule.matricule }}</option>
                    {% endif %}
                {% endfor %}
               </select>

            </div>

            <div class="form-group col-6">
              <label for="edit-conducteur">Conducteur</label>
             <select class="form-control" id="edit-conducteur" name="conducteur">
              <option value=""></option>
              {% for conducteur in conducteurs %}
              {% if conducteur.active == 1 %}
                <option value="{{ conducteur.id }}">{{ conducteur.nom }}</option>
                  {% endif %}
              {% endfor %}
            </select>
            </div>
          </div>

          <!-- Type et Zone -->
          <div class="form-row">
            <div class="form-group col-6">
              <label for="edit-type">Type</label>
              <input type="text" class="form-control" id="edit-type" readonly>
            </div>
            <div class="form-group col-6">
              <label for="edit-zone">Adresse d'arrivée</label>
              <input type="text" class="form-control" id="edit-zone" readonly>
            </div>
          </div>

          <!-- Prestation et Quantité -->
          <div class="form-row">
            <div class="form-group col-6">
              <label for="edit-prestation">Prestation</label>
              <input type="text" class="form-control" id="edit-prestation" readonly>
              <input type="hidden" id="edit-prestation-id">
              <input type="hidden" id="edit-iskilometrage" value="0" />


            </div>

            <div class="form-group col-6">
              <label for="edit-quantite">Quantité</label>
              <input type="number" class="form-control" id="edit-quantite" readonly>
            </div>
          </div>

         
         

            <div class="form-row">
            <div class="form-group col-6">
              <label for="edit-jawaz">Jawaz</label>
             <input type="number" class="form-control" id="edit-jawaz" name="details[0][jawaz]">
            </div>
            <div class="form-group col-6">
              <label for="edit-carburant">Carburant</label>
              <input type="text" class="form-control" id="edit-carburant" name="details[0][carburant]">
            </div>
          </div>
 <div class="form-row">
            <div class="form-group col-6">
              <label for="edit-jours">Nombre de jours</label>
              <input type="number" class="form-control" id="edit-jours" readonly>
            </div>

            <div class="form-group col-6" id="kilometrageGroup"  style="display: none;">
              <label for="edit-kilometrage">Kilométrage</label>
              <input type="number" class="form-control" id="edit-kilometrage" name="kilometrage">
            </div>
          </div>
        </div>
        <!-- Footer -->
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary" id="btn-enregistrer-detail">Enregistrer</button>
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Annuler</button>
        </div>
      </form>
    </div>  
  </div>
</div>

<!-- MODALS DÉTAILS Demande  -->
{% for demande in demandes %}
  <div class="modal right fade" id="detailDemandeModal{{ demande.id }}" tabindex="-1" aria-labelledby="detailDemandeModalLabel{{ demande.id }}" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title text-primary" id="detailDemandeModalLabel{{ demande.id }}" >Détails de la demande {{ demande.id }}</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close" id="">
            <span aria-hidden="true">&times;</span>   
          </button>
        </div>
        <div class="modal-body">
          <table class="table table-bordered table-sm">
            <thead>
              <tr>
                <th>#</th>
                <th>Prestation</th>
                {# <th>Type de prestation</th>
                <th>Adresse d'arrivée</th> #}
                <th>Conducteur</th>
                <th>Véhicule</th>         
                <th>Nb Jours</th>
                <th>Quantité</th>
                <th>Kilométrage</th>
                <th>Jawaz</th>
                <th>Carburant</th>
                <th>Tarif Unique</th>
              </tr>
            </thead>
            <tbody>
              {% for detail in detailsParDemande[demande.id]|default([]) %}
                <tr>
                  <td>{{ detail.id }}</td>
                  <td>{{ detail.prestationId ? detail.prestationId.nomPrestation : '—' }}</td>
                  {# <td>{{ detail.prestationId ? detail.prestationId.nomPrestation : '—' }}</td>
                  <td>{{ detail.prestationId ? detail.prestationId.nomPrestation : '—' }}</td> #}
                  <td>{{ detail.conducteurId ? detail.conducteurId.nom : '—' }}</td>
                  <td>{{ detail.vehiculeId ? detail.vehiculeId.matricule : '—' }}</td>
                  <td>{{ detail.nbjour }}</td>
                  <td>{{ detail.quantite }}</td>
                  <td>{{ detail.kilometrage }}</td>
                  <td>{{ detail.jawaz }}</td>
                  <td>{{ detail.carburant }}</td>
                  <td>{{ detail.tarif }}</td>
                </tr>
              {% else %}
                <tr>
                  <td colspan="7" class="text-center">Aucun détail disponible</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Fermer</button>
        </div>
      </div>
    </div>
  </div>
{% endfor %}




<script>
  const conducteurs = {{ conducteurs|json_encode|default('[]')|raw }};
  const vehicules = {{ vehicules|json_encode|default('[]')|raw }};
  const prestations = {{ prestations|json_encode|default('[]')|raw }};
  const typePrestations = {{ typePrestations|json_encode|default('[]')|raw }};


  
  {% for label, messages in app.flashes %}
    {% for message in messages %}
      toastr.{{ label }}('{{ message|e('js') }}');
    {% endfor %}
  {% endfor %}


</script>



{% endblock %}